import{r as e,c as t,h as s,F as i,H as r}from"./p-13c60fff.js";import{P as n,T as o}from"./p-33b03442.js";import{R as a,E as h}from"./p-3023e4d5.js";import{r as u,c,A as l,e as d,a as p,N as f,U as m}from"./p-fe40b0f4.js";import{S as w}from"./p-b681d68c.js";var g;(function(e){e["TOKEN_REFRESH_FAILED"]="TOKEN_REFRESH_FAILED";e["GENERATE_TOKEN_FOR_SERVER_FAILED"]="GENERATE_TOKEN_FOR_SERVER_FAILED";e["REFRESH_TOKEN_EXCHANGE_FAILED"]="REFRESH_TOKEN_EXCHANGE_FAILED";e["NOT_FEDERATED"]="NOT_FEDERATED";e["UNKNOWN_ERROR_CODE"]="UNKNOWN_ERROR_CODE"})(g||(g={}));class k extends Error{constructor(e="UNKNOWN_ERROR",t=g.UNKNOWN_ERROR_CODE,s,i,r){super(e);const n=new.target.prototype;Object.setPrototypeOf(this,n);this.name="ArcGISTokenRequestError";this.message=`${t}: ${e}`;this.originalMessage=e;this.code=t;this.response=s;this.url=i;this.options=r}}class b extends Error{constructor(){const e="The user has denied your authorization request.";super(e);const t=new.target.prototype;Object.setPrototypeOf(this,t);this.name="ArcGISAccessDeniedError"}}function v(e){const[t,s]=e.split("=");return{key:decodeURIComponent(t),value:decodeURIComponent(s)}}function E(e){if(!e||e.length<=0){return{}}return e.replace(/^#/,"").replace(/^\?/,"").split("&").reduce(((e,t)=>{const{key:s,value:i}=v(t);e[s]=i;return e}),{})}const T=5*60*1e3;function _(e,t){const s=t;s.rawResponse=false;return u(e,s).then((e=>{if("token"in e&&"expires"in e){return{token:e.token,username:t.params.username,expires:new Date(e.expires)}}const s={token:e.access_token,username:e.username,expires:new Date(Date.now()+e.expires_in*1e3-T),ssl:e.ssl===true};if(e.refresh_token){s.refreshToken=e.refresh_token}if(e.refresh_token_expires_in){s.refreshTokenExpires=new Date(Date.now()+e.refresh_token_expires_in*1e3-T)}return s}))}const I=/^https?:\/\/(\S+)\.arcgis\.com.+/;function C(e){return I.test(e)}function y(e){if(!I.test(e)){return e}switch(x(e)){case"dev":return"https://devext.arcgis.com/sharing/rest";case"qa":return"https://qaext.arcgis.com/sharing/rest";default:return"https://www.arcgis.com/sharing/rest"}}function x(e){if(!I.test(e)){return null}const t=e.match(I);const s=t[1].split(".").pop();if(s.includes("dev")){return"dev"}if(s.includes("qa")){return"qa"}return"production"}function O(e,t){const s=c(y(t)).replace(/https?:\/\//,"");const i=c(e).replace(/https?:\/\//,"");return new RegExp(i,"i").test(s)}function $(e,t){const s=C(e);const i=C(t);const r=x(e);const n=x(t);if(s&&i&&r===n){return true}return false}function S(e,t,s="https://www.arcgis.com/sharing/rest"){const i=`${s}/oauth2/validateAppAccess`;const r={method:"POST",params:{f:"json",client_id:t,token:e}};return u(i,r)}function R(e){const t=`${c(e.portal||"https://www.arcgis.com/sharing/rest")}/oauth2/revokeToken/`;const s=e.token;const i=e.clientId;delete e.portal;delete e.clientId;delete e.token;const r=Object.assign(Object.assign({},e),{httpMethod:"POST",params:{client_id:i,auth_token:s}});return u(t,r).then((e=>{if(!e.success){throw new l("Unable to revoke token",500,e,t,r)}return e}))}function A(e,t=window){if(!t&&window){t=window}return t.btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function U(e,t=window){if(!t&&window){t=window}if(e&&t.isSecureContext&&t.crypto&&t.crypto.subtle){const s=new t.TextEncoder;const i=s.encode(e);return t.crypto.subtle.digest("SHA-256",i).then((e=>A(new Uint8Array(e),t)))}return Promise.resolve(null)}function P(e){if(!e&&window){e=window}const t=e.crypto.getRandomValues(new Uint8Array(32));return A(t)}class j{constructor(e){this.clientId=e.clientId;this._refreshToken=e.refreshToken;this._refreshTokenExpires=e.refreshTokenExpires;this._username=e.username;this.password=e.password;this._token=e.token;this._tokenExpires=e.tokenExpires;this.portal=e.portal?c(e.portal):"https://www.arcgis.com/sharing/rest";this.ssl=e.ssl;this.provider=e.provider||"arcgis";this.tokenDuration=e.tokenDuration||20160;this.redirectUri=e.redirectUri;this.server=e.server;this.referer=e.referer;this.federatedServers={};this.trustedDomains=[];if(e.server){const t=this.getServerRootUrl(e.server);this.federatedServers[t]={token:e.token,expires:e.tokenExpires}}this._pendingTokenRequests={}}get token(){return this._token}get tokenExpires(){return this._tokenExpires}get refreshToken(){return this._refreshToken}get refreshTokenExpires(){return this._refreshTokenExpires}get username(){if(this._username){return this._username}if(this._user&&this._user.username){return this._user.username}}get canRefresh(){if(this.username&&this.password){return true}if(this.clientId&&this.refreshToken&&this.redirectUri){return true}return false}static beginOAuth2(e,t){if(!t&&window){t=window}const{portal:s,provider:i,clientId:r,expiration:n,redirectUri:o,popup:a,popupWindowFeatures:h,locale:u,params:l,style:f,pkce:m,state:w}=Object.assign({portal:"https://www.arcgis.com/sharing/rest",provider:"arcgis",expiration:20160,popup:true,popupWindowFeatures:"height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes",locale:"",style:"",pkce:true},e);const g=w||P(t);const k=`ARCGIS_REST_JS_AUTH_STATE_${r}`;t.localStorage.setItem(k,g);let v=`${c(s)}/oauth2/authorize`;const E={client_id:r,response_type:m?"code":"token",expiration:n,redirect_uri:o,state:JSON.stringify({id:g,originalUrl:t.location.href}),locale:u,style:f};if(i!=="arcgis"){v=`${c(s)}/oauth2/social/authorize`;E.socialLoginProviderName=i;E.autoAccountCreateForSocial=true}let T;if(m){const e=P(t);const s=`ARCGIS_REST_JS_CODE_VERIFIER_${r}`;t.localStorage.setItem(s,e);T=U(e,t).then((function(t){E.code_challenge_method=t?"S256":"plain";E.code_challenge=t?t:e}))}else{T=Promise.resolve()}return T.then((()=>{v=`${v}?${d(E)}`;if(l){v=`${v}&${d(l)}`}if(a){return new Promise(((e,i)=>{t.addEventListener(`arcgis-rest-js-popup-auth-${r}`,(t=>{if(t.detail.error==="access_denied"){const e=new b;i(e);return e}if(t.detail.errorMessage){const e=new p(t.detail.errorMessage,t.detail.error);i(e);return e}e(new j({clientId:r,portal:s,ssl:t.detail.ssl,token:t.detail.token,tokenExpires:t.detail.expires,username:t.detail.username,refreshToken:t.detail.refreshToken,refreshTokenExpires:t.detail.refreshTokenExpires,redirectUri:o}))}),{once:true});t.open(v,"oauth-window",h);t.dispatchEvent(new CustomEvent("arcgis-rest-js-popup-auth-start"))}))}else{t.location.href=v;return undefined}}))}static completeOAuth2(e,t){if(!t&&window){t=window}const{portal:s,clientId:i,popup:r,pkce:n,redirectUri:o}=Object.assign({portal:"https://www.arcgis.com/sharing/rest",popup:true,pkce:true},e);const a=`ARCGIS_REST_JS_AUTH_STATE_${i}`;const h=t.localStorage.getItem(a);const u=E(n?t.location.search.replace(/^\?/,""):t.location.hash.replace(/^#/,""));const l=u&&u.state?JSON.parse(u.state):undefined;function d(e,s,n){t.localStorage.removeItem(a);if(r&&t.opener){t.opener.dispatchEvent(new CustomEvent(`arcgis-rest-js-popup-auth-${i}`,{detail:{error:s,errorMessage:e}}));t.close();return}if(n){t.history.replaceState(t.history.state,"",n)}if(s==="access_denied"){return Promise.reject(new b)}return Promise.reject(new p(e,s))}function f(e,n){t.localStorage.removeItem(a);if(r&&t.opener){t.opener.dispatchEvent(new CustomEvent(`arcgis-rest-js-popup-auth-${i}`,{detail:Object.assign({},e)}));t.close();return}t.history.replaceState(t.history.state,"",n);return new j({clientId:i,portal:s,ssl:e.ssl,token:e.token,tokenExpires:e.expires,username:e.username,refreshToken:e.refreshToken,refreshTokenExpires:e.refreshTokenExpires,redirectUri:o||location.href.replace(location.search,"")})}if(!h||!l){return d("No authentication state was found, call `ArcGISIdentityManager.beginOAuth2(...)` to start the authentication process.","no-auth-state")}if(l.id!==h){return d("Saved client state did not match server sent state.","mismatched-auth-state")}if(u.error){const e=u.error;const t=u.error_description||"Unknown error";return d(t,e,l.originalUrl)}if(n&&u.code){const e=c(`${s}/oauth2/token/`);const r=`ARCGIS_REST_JS_CODE_VERIFIER_${i}`;const n=t.localStorage.getItem(r);t.localStorage.removeItem(r);return _(e,{httpMethod:"POST",params:{client_id:i,code_verifier:n,grant_type:"authorization_code",redirect_uri:o||location.href.replace(location.search,""),code:u.code}}).then((e=>f(Object.assign(Object.assign({},e),l),l.originalUrl))).catch((e=>d(e.originalMessage,e.code,l.originalUrl)))}if(!n&&u.access_token){return Promise.resolve(f(Object.assign({token:u.access_token,expires:new Date(Date.now()+parseInt(u.expires_in,10)*1e3),ssl:u.ssl==="true",username:u.username},l),l.originalUrl))}return d("Unknown error","oauth-error",l.originalUrl)}static fromParent(e,t){if(!t&&window){t=window}let s;return new Promise(((i,r)=>{s=e=>{if(e.source===t.parent&&e.data){try{return i(j.parentMessageHandler(e))}catch(e){return r(e)}}};t.addEventListener("message",s,false);t.parent.postMessage({type:"arcgis:auth:requestCredential"},e)})).then((e=>{t.removeEventListener("message",s,false);return e}))}static authorize(e,t){const{portal:s,clientId:i,expiration:r,redirectUri:n,state:o}=Object.assign({portal:"https://arcgis.com/sharing/rest",expiration:20160},e);const a={client_id:i,expiration:r,response_type:"code",redirect_uri:n};if(o){a.state=o}const h=`${s}/oauth2/authorize?${d(a)}`;t.writeHead(301,{Location:h});t.end()}static exchangeAuthorizationCode(e,t){const{portal:s,clientId:i,redirectUri:r}=Object.assign({portal:"https://www.arcgis.com/sharing/rest"},e);return _(`${s}/oauth2/token`,{params:{grant_type:"authorization_code",client_id:i,redirect_uri:r,code:t}}).then((e=>new j({clientId:i,portal:s,ssl:e.ssl,redirectUri:r,refreshToken:e.refreshToken,refreshTokenExpires:e.refreshTokenExpires,token:e.token,tokenExpires:e.expires,username:e.username}))).catch((e=>{throw new k(e.message,g.REFRESH_TOKEN_EXCHANGE_FAILED,e.response,e.url,e.options)}))}static deserialize(e){const t=JSON.parse(e);return new j({clientId:t.clientId,refreshToken:t.refreshToken,refreshTokenExpires:t.refreshTokenExpires?new Date(t.refreshTokenExpires):undefined,username:t.username,password:t.password,token:t.token,tokenExpires:t.tokenExpires?new Date(t.tokenExpires):undefined,portal:t.portal,ssl:t.ssl,tokenDuration:t.tokenDuration,redirectUri:t.redirectUri,server:t.server})}static fromCredential(e,t){const s=typeof e.ssl!=="undefined"?e.ssl:true;const i=e.expires||Date.now()+72e5;if(t.hasServer){return new j({server:e.server,ssl:s,token:e.token,username:e.userId,tokenExpires:new Date(i)})}return new j({portal:c(e.server.includes("sharing/rest")?e.server:e.server+`/sharing/rest`),ssl:s,token:e.token,username:e.userId,tokenExpires:new Date(i)})}static parentMessageHandler(e){if(e.data.type==="arcgis:auth:credential"){return new j(e.data.credential)}if(e.data.type==="arcgis:auth:error"){const t=new Error(e.data.error.message);t.name=e.data.error.name;throw t}else{throw new Error("Unknown message type.")}}static destroy(e){return R({clientId:e.clientId,portal:e.portal,token:e.refreshToken||e.token})}static fromToken(e){const t=new j(e);return t.getUser().then((()=>t))}static signIn(e){const t=new j(e);return t.getUser().then((()=>t))}toCredential(){return{expires:this.tokenExpires.getTime(),server:this.server||this.portal,ssl:this.ssl,token:this.token,userId:this.username}}getUser(e){if(this._pendingUserRequest){return this._pendingUserRequest}else if(this._user){return Promise.resolve(this._user)}else{const t=`${this.portal}/community/self`;const s=Object.assign(Object.assign({httpMethod:"GET",authentication:this},e),{rawResponse:false});this._pendingUserRequest=u(t,s).then((e=>{this._user=e;this._pendingUserRequest=null;return e}));return this._pendingUserRequest}}getPortal(e){if(this._pendingPortalRequest){return this._pendingPortalRequest}else if(this._portalInfo){return Promise.resolve(this._portalInfo)}else{const t=`${this.portal}/portals/self`;const s=Object.assign(Object.assign({httpMethod:"GET",authentication:this},e),{rawResponse:false});this._pendingPortalRequest=u(t,s).then((e=>{this._portalInfo=e;this._pendingPortalRequest=null;return e}));return this._pendingPortalRequest}}getUsername(){if(this.username){return Promise.resolve(this.username)}else{return this.getUser().then((e=>e.username))}}getToken(e,t){if($(this.portal,e)){return this.getFreshToken(t)}else if(new RegExp(this.portal,"i").test(e)){return this.getFreshToken(t)}else{return this.getTokenForServer(e,t)}}validateAppAccess(e){return this.getToken(this.portal).then((t=>S(t,e)))}toJSON(){return{clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires||undefined,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires||undefined,portal:this.portal,ssl:this.ssl,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,server:this.server}}serialize(){return JSON.stringify(this)}enablePostMessageAuth(e,t){if(!t&&window){t=window}this._hostHandler=this.createPostMessageHandler(e);t.addEventListener("message",this._hostHandler,false)}disablePostMessageAuth(e){if(!e&&window){e=window}e.removeEventListener("message",this._hostHandler,false)}refreshCredentials(e){this._user=null;if(this.username&&this.password){return this.refreshWithUsernameAndPassword(e)}if(this.clientId&&this.refreshToken){return this.refreshWithRefreshToken()}return Promise.reject(new k("Unable to refresh token. No refresh token or password present.",g.TOKEN_REFRESH_FAILED))}getServerRootUrl(e){const[t]=c(e).split(/\/rest(\/admin)?\/services(?:\/|#|\?|$)/);const[s,i,r]=t.match(/(https?:\/\/)(.+)/);const[n,...o]=r.split("/");return`${i}${n.toLowerCase()}/${o.join("/")}`}getDomainCredentials(e){if(!this.trustedDomains||!this.trustedDomains.length){return"same-origin"}return this.trustedDomains.some((t=>e.startsWith(t)))?"include":"same-origin"}signOut(){return j.destroy(this)}createPostMessageHandler(e){return t=>{const s=e.indexOf(t.origin)>-1;const i=t.data.type==="arcgis:auth:requestCredential";const r=this.tokenExpires.getTime()>Date.now();if(s&&i){let e={};if(r){const t=this.toJSON();e={type:"arcgis:auth:credential",credential:t}}else{e={type:"arcgis:auth:error",error:{name:"tokenExpiredError",message:"Token was expired, and not returned to the child application"}}}t.source.postMessage(e,t.origin)}}}getTokenForServer(e,t){const s=this.getServerRootUrl(e);const i=this.federatedServers[s];if(i&&i.expires&&i.expires.getTime()>Date.now()){return Promise.resolve(i.token)}if(this._pendingTokenRequests[s]){return this._pendingTokenRequests[s]}this._pendingTokenRequests[s]=this.fetchAuthorizedDomains().then((()=>u(`${s}/rest/info`,{credentials:this.getDomainCredentials(e)}).then((i=>{if(i.owningSystemUrl){if(!O(i.owningSystemUrl,this.portal)){throw new k(`${e} is not federated with ${this.portal}.`,g.NOT_FEDERATED)}else{return u(`${i.owningSystemUrl}/sharing/rest/info`,t)}}else if(i.authInfo&&this.federatedServers[s]!==undefined){return Promise.resolve({authInfo:i.authInfo})}else{throw new k(`${e} is not federated with any portal and is not explicitly trusted.`,g.NOT_FEDERATED)}})).then((e=>{if(this.token&&this.tokenExpires.getTime()<Date.now()){if(this.server){return this.refreshCredentials().then((()=>({token:this.token,expires:this.tokenExpires})))}return this.refreshCredentials().then((()=>this.generateTokenForServer(e.authInfo.tokenServicesUrl,s)))}else{return this.generateTokenForServer(e.authInfo.tokenServicesUrl,s)}})).then((e=>{this.federatedServers[s]=e;delete this._pendingTokenRequests[s];return e.token}))));return this._pendingTokenRequests[s]}generateTokenForServer(e,t){return u(e,{params:{token:this.token,serverUrl:t,expiration:this.tokenDuration}}).then((e=>({token:e.token,expires:new Date(e.expires-1e3*60*5)}))).catch((e=>{throw new k(e.message,g.GENERATE_TOKEN_FOR_SERVER_FAILED,e.response,e.url,e.options)}))}getFreshToken(e){if(this.token&&!this.tokenExpires){return Promise.resolve(this.token)}if(this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()){return Promise.resolve(this.token)}if(!this._pendingTokenRequests[this.portal]){this._pendingTokenRequests[this.portal]=this.refreshCredentials(e).then((()=>{this._pendingTokenRequests[this.portal]=null;return this.token}))}return this._pendingTokenRequests[this.portal]}refreshWithUsernameAndPassword(e){const t={username:this.username,password:this.password,expiration:this.tokenDuration,client:"referer",referer:this.referer?this.referer:typeof window!=="undefined"&&typeof window.document!=="undefined"&&window.location&&window.location.origin?window.location.origin:f};return(this.server?u(`${this.getServerRootUrl(this.server)}/rest/info`).then((s=>u(s.authInfo.tokenServicesUrl,Object.assign({params:t},e)))):u(`${this.portal}/generateToken`,Object.assign({params:t},e))).then((e=>{this.updateToken(e.token,new Date(e.expires));return this})).catch((e=>{throw new k(e.message,g.TOKEN_REFRESH_FAILED,e.response,e.url,e.options)}))}refreshWithRefreshToken(e){const t=1e3*60*60*24;if(this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()-t<Date.now()){return this.exchangeRefreshToken(e)}const s=Object.assign({params:{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}},e);return _(`${this.portal}/oauth2/token`,s).then((e=>this.updateToken(e.token,e.expires))).catch((e=>{throw new k(e.message,g.TOKEN_REFRESH_FAILED,e.response,e.url,e.options)}))}updateToken(e,t){this._token=e;this._tokenExpires=t;return this}exchangeRefreshToken(e){const t=Object.assign({params:{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}},e);return _(`${this.portal}/oauth2/token`,t).then((e=>{this._token=e.token;this._tokenExpires=e.expires;this._refreshToken=e.refreshToken;this._refreshTokenExpires=e.refreshTokenExpires;return this})).catch((e=>{throw new k(e.message,g.REFRESH_TOKEN_EXCHANGE_FAILED,e.response,e.url,e.options)}))}fetchAuthorizedDomains(){if(this.server||!this.portal){return Promise.resolve(this)}return this.getPortal().then((e=>{if(e.authorizedCrossOriginDomains&&e.authorizedCrossOriginDomains.length){this.trustedDomains=e.authorizedCrossOriginDomains.filter((e=>!e.startsWith("http://"))).map((e=>{if(e.startsWith("https://")){return e}else{return`https://${e}`}}))}return this}))}}const F=":host{background-color:var(--calcite-color-foreground-1);color:var(--calcite-color-text-2);display:block;overflow:auto}:host div.banner{display:block;cursor:pointer;line-height:60px}:host .task-num{display:inline-block;height:16px;text-align:center;border-radius:16px;border-color:#31872E;background-color:#31872E;margin-left:4px;color:#ffffff;line-height:16px !important;transition:all 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28)}:host .task-num span{position:relative;line-height:1 !important;color:#ffffff;padding:1px 4px}:host .task-num.active{-webkit-transform:scale(1.2);transform:scale(1.2)}:host .error-message{word-break:break-word}:host-context([dir=rtl]) .task-num{margin-left:unset !important;margin-right:4px}";const D=F;const N=class{constructor(s){e(this,s);this.userInfoGetted=t(this,"userInfoGetted",7);this.i18nStringUpdated=t(this,"i18nStringUpdated",7);this._credentialGetted=t(this,"_credentialGetted",7);this.stateService=w.getService();this.reportService=a.getService();this.token=undefined;this.portalUrl=undefined;this.apiUrl=undefined;this.featureLayerUrl=undefined;this.surveyItemId=undefined;this.templateItemId=undefined;this.queryParameters=undefined;this.mergeFiles=undefined;this.outputFormat=undefined;this.outputReportName=undefined;this.outputPackageName=undefined;this.packageFiles=undefined;this.uploadInfo=undefined;this.webmapItemId=undefined;this.mapScale=undefined;this.locale=undefined;this.utcOffset=undefined;this.show=undefined;this.hide=undefined;this.inputFeatureTemplate=undefined;this.label=undefined;this.reportTemplateIds=undefined;this.clientId=undefined;this.requestSource=undefined;this.where=undefined;this.username=undefined;this.state="generate-report";this.visibleConf=[];this.checkingList=[];this.jobs=[];this.error=undefined;this.langTasks=undefined;this.langCommon=undefined;this.langCustomPrint=undefined;this.surveyItemInfo=undefined}templateItemIdChanged(e){n.setProps({templateItemId:e})}queryParametersChanged(e){n.setProps({queryParameters:e});return this.reportService.getFeatureCount().then((()=>{this.stateService.notifyDataChanged("update-features-preview",{value:undefined})}))}mergeFilesChanged(e){n.setProps({mergeFiles:e})}outputFormatChanged(e){n.setProps({outputFormat:e});this.outputFormat=n.outputFormat}localeChanged(e){this.localeChangeHandler(e);m.getService().setDir()}showChanged(e){n.setProps({show:e});this.visibleConf=this.generateVisibleElems();this.reportService.setHelperObj({visibleConf:this.visibleConf})}hideChanged(e){n.setProps({hide:e});this.visibleConf=this.generateVisibleElems();this.reportService.setHelperObj({visibleConf:this.visibleConf})}inputFeatureTemplateChanged(e){n.setProps({inputFeatureTemplate:e});this.stateService.notifyDataChanged("update-features-preview",{value:this.inputFeatureTemplate})}labelChanged(e){n.setProps({label:e});return Promise.resolve(true).then((()=>o.getService().getTranslate())).then((e=>{const t=e.customPrint.recentTasks;this.langCustomPrint=e.customPrint;this.langTasks=t;this.langCommon=e.common;this.stateService.notifyDataChanged("locale-data-changed",{value:e})}))}reportTemplateIdsChanged(e){n.setProps({reportTemplateIds:e});this.updateTemplateList()}requestSourceChanged(e){n.setProps({requestSource:e})}componentWillLoad(){n.setProps(this);this.portalUrl=n.portalUrl;this.outputFormat=n.outputFormat;return Promise.resolve(true).then((()=>o.getService().getTranslate())).then((e=>{const t=e.customPrint.recentTasks;this.langCustomPrint=e.customPrint;this.langTasks=t;this.langCommon=e.common;this.i18nStringUpdated.emit({locale:n.locale,i18n:this.langCommon});if(!this.isOAuthCallbackpage()){if(!this.featureLayerUrl){this.error={html:e.customPrint.missingRequiredParamsErr.replace("${$paramName}",`featureLayerUrl`)};throw new Error("featureLayerUrl is required.")}if(!this.queryParameters){this.error={html:e.customPrint.missingRequiredParamsErr.replace("${$paramName}",`queryParameters`)};throw new Error("queryParameters is required.")}}})).then((()=>{if(this.token){this.init();return true}else if(!this.token){if(this.isOAuthCallbackpage()){const e=`${this.portalUrl}/sharing/rest`;const t=new URL(window.location.href);const s=`${t.origin}${t.pathname}?portalUrl=${this.portalUrl}&isOAuthCallback=true`;j.completeOAuth2({portal:e,popup:true,clientId:this.clientId,redirectUri:s});return}else{const e=`${this.portalUrl}/sharing/rest/oauth2/platformSelf?f=json`;const t={httpMethod:"POST",headers:{"X-Esri-Auth-Client-Id":this.clientId,"X-Esri-Auth-Redirect-Uri":window.location.href},params:{f:"json"},credentials:"include"};return u(e,t).then((e=>{if(e.expires_in){e.expires=(new Date).valueOf()+e.expires_in*1e3-1e3*5;delete e.expires_in}this._credentialGetted.emit(e);this.token=e.token;n.setProps(this);this.init();return true})).catch((()=>{this.state="login"}))}}})).catch((e=>{console.error(e)}))}init(){const e=m.getService();this.stateService.subscribe("job-complete",(e=>{var t;const s=this.checkingList.indexOf(e.jobId);if(s>=0){if(e.jobStatus===h.partialSucceeded||e.jobStatus===h.succeeded){if((t=e===null||e===void 0?void 0:e.resultInfo)===null||t===void 0?void 0:t.resultFiles){this.checkingList.splice(s,1);this.checkingList=[].concat(this.checkingList);this.reportService.downloadReport(e)}}}}));this.stateService.subscribe("show-error",(e=>{this.error=e}));return Promise.resolve(true).then((()=>{if(this.uploadInfo){this.reportService.setParamCache({uploadInfo:JSON.parse(this.uploadInfo)})}return true})).then((()=>e.getPortalInfo())).then((t=>{const s=t.user.privileges.includes("portal:user:createItem");this.reportService.setHelperObj({canCreateItem:s});this.userInfoGetted.emit(t.user);if(!this.locale){const e=n.getLocale({userInfo:t.user,portalInfo:t});if(e!==n.locale){this.localeChangeHandler(e)}}else{this.i18nStringUpdated.emit({locale:this.locale,i18n:this.langCommon})}m.getService().setDir();this.visibleConf=this.generateVisibleElems();this.reportService.setHelperObj({visibleConf:this.visibleConf});this.stateService.notifyDataChanged("portal-info-updated");if(n.surveyItemId){return e.getSurveyItemInfo(n.surveyItemId)}})).catch((e=>{this.reportService.setHelperObj({surveyIsInvalid:true});this.surveyItemInfo={};this.reportService.manageError(e,"surveyItemId")})).then((e=>{this.surveyItemInfo=e;this.reportService.setHelperObj({surveyIsInvalid:false});this.reportService.initParamCache();return this.reportService.getFeatureCount()})).then((()=>{this.stateService.notifyDataChanged("update-features-preview",{value:undefined});return this.updateTemplateList()})).catch((e=>{if(e.message&&!e.html){e.html=e.message}this.error=e}))}startLogin(){const e=`${this.portalUrl}/sharing/rest`;const t=new URL(window.location.href);const s=`${t.origin}${t.pathname}?portalUrl=${this.portalUrl}&isOAuthCallback=true`;return j.beginOAuth2({portal:e,popup:true,clientId:this.clientId,redirectUri:s}).then((e=>{this.token=e.token;n.setProps(this);this.switchState("generate-report");this.init();this._credentialGetted.emit(e.toCredential());return true}))}isOAuthCallbackpage(){const e=new URL(window.location.href);return(e.search+"").includes("isOAuthCallback=true")}localeChangeHandler(e){n.setProps({locale:e});return Promise.resolve(true).then((()=>o.getService().getTranslate())).then((t=>{const s=t.customPrint.recentTasks;this.langCustomPrint=t.customPrint;this.langTasks=s;this.langCommon=t.common;this.stateService.notifyDataChanged("locale-data-changed",{value:t});this.i18nStringUpdated.emit({locale:e,i18n:this.langCommon});return true}))}generateVisibleElems(){var e,t;const s=["inputFeatures","selectTemplate","fileOptions","reportName","saveToAGSAccount","outputFormat","showCredits","recentReports"];let i=[];if((e=this.show)===null||e===void 0?void 0:e.length){i=this.show.split(",")}else if((t=this.hide)===null||t===void 0?void 0:t.length){const e=this.hide.split(",");i=s.filter((t=>e.indexOf(t)<0))}else{i=s}if(i.indexOf("fileOptions")<0&&i.indexOf("reportName")<0&&i.indexOf("saveToAGSAccount")<0&&i.indexOf("outputFormat")<0);else{i.push("reportSetting")}return[].concat(i)}switchState(e){this.state=e}updateTemplateList(){return Promise.resolve(true).then((()=>{if(this.visibleConf.indexOf("selectTemplate")<0){const e=this.reportTemplateIds===undefined?{}:{templateIds:this.reportTemplateIds};return this.reportService.getReportTemplates(this.surveyItemId,e)}})).then((e=>{if(e){this.reportService.setHelperObj({printTemplates:e});this.stateService.notifyDataChanged("print-templates-updated",{value:e});const t=this.reportService.getParamCache();const s=t.templateItemId||n.templateItemId;if(!s&&e.length){const t=e[0].id;this.reportService.setParamCache({templateItemId:t})}}}))}generateReportHander(e){const t=e.detail;this.jobs=t.jobs;this.checkingList=[...this.checkingList,e.detail.jobId];this.state="report-list"}render(){var e,t,o,a,h;return s(r,{key:"372606ed791cd7d1ef7fb882c716ca76840a45f2"},s("calcite-panel",{key:"a7346f03688cfdb7440bf8e40363176fa1c8515b"},s("div",{key:"652e818cf3cf99a5df2a0a19e0c141c96acd080d",style:{display:this.state==="generate-report"&&this.token?"block":"none"}},this.visibleConf.indexOf("inputFeatures")<0?"":s("features-preview",{queryParameters:this.queryParameters,inputFeatureTemplate:this.inputFeatureTemplate}),this.visibleConf.indexOf("selectTemplate")<0||!this.surveyItemInfo?"":s("template-chooser",{selectedTemplateId:this.templateItemId,templateIds:this.reportTemplateIds}),this.visibleConf.indexOf("reportSetting")<0?"":s("report-settings",{visibleElems:this.visibleConf,mergeFiles:this.mergeFiles,outputFormat:this.outputFormat,fileName:this.outputReportName}),s("report-generator",{key:"c5d2c57bd3086446b9317ef344c5ae86a9f11420",visibleConf:this.visibleConf,templateItemId:this.templateItemId,onReportCreated:e=>{this.generateReportHander(e)}}),this.visibleConf.indexOf("recentReports")<0?null:s("div",{class:"banner"},s("calcite-action",{onClick:()=>this.switchState("report-list"),icon:"chevrons-right","text-enabled":true},s("span",null,(e=this.langTasks)===null||e===void 0?void 0:e.label),((t=this.checkingList)===null||t===void 0?void 0:t.length)?s(i,null,s("div",{class:"task-num",id:"task-num"},s("span",null,`${this.checkingList.length||""}`)),s("calcite-tooltip",{label:this.langTasks.panelNumberTip,"reference-element":"task-num"},s("span",null,this.langTasks.panelNumberTip))):null))),this.token?s("task-list",{style:{display:this.state==="report-list"?"block":"none"},jobs:this.jobs,onGoBackClicked:()=>{this.state="generate-report"}}):"",this.error?s("calcite-alert",{slot:"alerts",open:true,onCalciteAlertClose:()=>{this.error=null},label:this.error.html,icon:true,kind:this.error.alertType||"danger",placement:"top",scale:"s"},s("div",{class:"error-message",slot:"message"},this.error.html,this.error.detail?s("p",{innerHTML:this.error.detail}):null)):null,this.state==="login"&&!n.token?s("calcite-modal",{"aria-labelledby":"modal-title",id:"login-modal","outside-close-disabled":"true",scale:"s","width-scale":"s","close-button-disabled":"true",open:"true"},s("div",{slot:"header",id:"modal-title"},(o=this.langCommon)===null||o===void 0?void 0:o.signIn),s("div",{slot:"content"},s("calcite-label",{style:{height:"100px"}},s("p",null,(a=this.langCommon)===null||a===void 0?void 0:a.signInMsg),s("calcite-button",{id:"reportLoginBtn",kind:"brand",onClick:()=>this.startLogin()},(h=this.langCommon)===null||h===void 0?void 0:h.signIn)))):""),s("slot",{key:"22b3f6908b27655eabd64ab0e452f706d4528752"}))}static get watchers(){return{templateItemId:["templateItemIdChanged"],queryParameters:["queryParametersChanged"],mergeFiles:["mergeFilesChanged"],outputFormat:["outputFormatChanged"],locale:["localeChanged"],show:["showChanged"],hide:["hideChanged"],inputFeatureTemplate:["inputFeatureTemplateChanged"],label:["labelChanged"],reportTemplateIds:["reportTemplateIdsChanged"],requestSource:["requestSourceChanged"]}}};N.style=D;export{N as feature_report};
//# sourceMappingURL=p-a53589e0.entry.js.map